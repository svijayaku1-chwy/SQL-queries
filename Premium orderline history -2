Premium orderline history -2
WITH CUSTOMERS AS (
  
  SELECT
  CUSTOMER_ID,
  CASE WHEN ORDERS_L3M > 0 THEN 1 ELSE 0 END AS ACTIVE_3M, 
  ORDERS_L3M,
  ORDERS_L6M,
  ORDERS_L9M,
  ORDERS_L12M,
  FIRST_ORDER_DATE,
  LAST_ORDER_DATE,
  AUTOSHIP_STATUS,
  REGISTRATION_DATE
  FROM CDM.CUSTOMER_AGGREGATE
  
  WHERE REGISTRATION_DATE >= '2021-01-01'
),

ORDERS AS (
  
  SELECT
  CA.CUSTOMER_ID,
  CA.REGISTRATION_DATE,
  CA.FIRST_ORDER_DATE,
  OL.ORDER_ID,
  OL.PRODUCT_ID,
  PD.MANUFACTURER_NAME,
  PD.CATEGORY_LEVEL1,
  PD.CATEGORY_LEVEL2,
  PD.CATEGORY_LEVEL3,
  PD.MERCH_CLASSIFICATION1,
  PD.MERCH_CLASSIFICATION2,
  PD.PRODUCT_TYPE,
  CAST(OL.ORDER_PLACED_DTTM AS DATE) AS ORDER_PLACED_DATE

  FROM CUSTOMERS CA
  
  LEFT JOIN ECOM.ORDER_LINE OL
  ON CA.CUSTOMER_ID = OL.CUSTOMER_ID 
  AND OL.ORDER_LINE_TOTAL_PRICE != 0
  AND OL.ORDER_LINE_SHIPPED_DTTM IS NOT NULL
  AND OL.ORDER_STATUS NOT IN ('X', 'P', 'J')
  
  LEFT JOIN PDM.PRODUCT PD
  ON OL.PRODUCT_ID = PD.PRODUCT_ID
  
  where ol.ORDER_PLACED_DTTM >= '2021-01-01' 
),

//PREMIUM_CUSTOMERS AS (
//select CUSTOMER_ID,PREM_RATIO from (
//    select 
//      DISTINCT 
//      ca.CUSTOMER_ID,
//        DIV0(
//        COUNT(DISTINCT (CASE when ol.PART_NUMBER in (select DISTINCT PART_NUMBER from ECOM_SANDBOX.PREMIUM_PRODUCT_LIST) THEN ol.ORDER_ID ELSE NULL END))*100,
//        COUNT(DISTINCT ol.ORDER_ID)) 
//        as PREM_RATIO
//    from CDM.CUSTOMER_AGGREGATE ca
//    INNER JOIN ecom.order_line ol
//        ON ol.CUSTOMER_ID = ca.CUSTOMER_ID
//        AND ol.ORDER_PLACED_DTTM >= '2021-01-01' 
//        AND ca.REGISTRATION_CANCEL_DATE is null
//        AND ca.REGISTRATION_DATE >= '2021-01-01'
//    INNER JOIN pdm.product pd
//        ON ol.PRODUCT_ID = pd.PRODUCT_ID
//        AND OL.ORDER_STATUS NOT IN ('X', 'P', 'J')
//        AND pd.MERCH_CLASSIFICATION1 in ('Consumables','Premium')
//    group by ca.CUSTOMER_ID
//    having COUNT(DISTINCT ol.ORDER_ID) >= 3
//  ) where PREM_RATIO >= 30
//),

ALL_CORE_FOOD AS (
  select
  DISTINCT ca.CUSTOMER_ID
    from CDM.CUSTOMER_AGGREGATE ca
    INNER JOIN ecom.order_line ol
        ON ol.CUSTOMER_ID = ca.CUSTOMER_ID
        AND ol.ORDER_PLACED_DTTM >= '2021-01-01'
        AND ca.REGISTRATION_CANCEL_DATE is null
        AND ca.REGISTRATION_DATE >= '2021-01-01'
    INNER JOIN pdm.product pd
        ON ol.PRODUCT_ID = pd.PRODUCT_ID
        AND OL.ORDER_STATUS NOT IN ('X', 'P', 'J')
        AND pd.MERCH_CLASSIFICATION1 = 'Consumables'
        AND pd.MERCH_CLASSIFICATION2 = 'Core Food'
    group by ca.CUSTOMER_ID
    having COUNT(DISTINCT ol.ORDER_ID) >= 3
),

CORE_FOOD_TO_PREM AS (
  SELECT A.CUSTOMER_ID
  FROM ALL_CORE_FOOD AS A
  INNER JOIN "EDLDB"."ECOM_SANDBOX"."PREMIUM_CUSTOMER_LIST" AS P
  ON A.CUSTOMER_ID = P.CUSTOMER_ID
),

FIRST_PREMIUM_DATE AS (
  SELECT
      p.CUSTOMER_ID,
      MIN(CASE WHEN PRODUCT_ID IN (select DISTINCT PRODUCT_ID from ECOM_SANDBOX.PREMIUM_PRODUCT_LIST) THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_PREMIUM_DATE

  FROM CORE_FOOD_TO_PREM as p
  LEFT JOIN ORDERS as o
  ON p.CUSTOMER_ID = o.CUSTOMER_ID

  GROUP BY 1
)

SELECT 
    p.CUSTOMER_ID,
    FIRST_PREMIUM_DATE,
    CASE WHEN FIRST_ORDER_DATE = FIRST_PREMIUM_DATE THEN 1 ELSE 0 END AS IS_FIRST_PREMIUM,
    O.ORDER_PLACED_DATE,
    O.ORDER_ID,
    O.PRODUCT_ID,
    O.MANUFACTURER_NAME,
    O.CATEGORY_LEVEL1,
    O.CATEGORY_LEVEL2,
    O.CATEGORY_LEVEL3,
    O.MERCH_CLASSIFICATION1,
    O.MERCH_CLASSIFICATION2,
    O.PRODUCT_TYPE
    
FROM ORDERS AS O
JOIN FIRST_PREMIUM_DATE as p
  ON p.CUSTOMER_ID = o.CUSTOMER_ID
  
WHERE O.ORDER_PLACED_DATE < FIRST_PREMIUM_DATE
//GROUP BY 1
ORDER BY 1
;