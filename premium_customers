premium_customers
WITH CUSTOMERS AS (
  SELECT DISTINCT
  CUSTOMER_ID,
  CASE WHEN ORDERS_L3M > 0 THEN 1 ELSE 0 END AS ACTIVE_3M, 
  FIRST_ORDER_DATE,
  LAST_ORDER_DATE,
  REGISTRATION_DATE
  FROM CDM.CUSTOMER_AGGREGATE
  
  WHERE REGISTRATION_DATE >= '2018-01-01'
),

ORDERS AS (
  
  SELECT
  CA.CUSTOMER_ID,
  CA.REGISTRATION_DATE,
  CA.FIRST_ORDER_DATE,
  OL.ORDER_ID,
  OL.PRODUCT_ID
  
  FROM CUSTOMERS CA
  
  LEFT JOIN ECOM.ORDER_LINE OL
  ON CA.CUSTOMER_ID = OL.CUSTOMER_ID 
  AND OL.ORDER_LINE_TOTAL_PRICE != 0
  AND OL.ORDER_LINE_SHIPPED_DTTM IS NOT NULL
  AND OL.ORDER_STATUS NOT IN ('X', 'P', 'J')
  AND OL.ORDER_PLACED_DTTM >= '2021-01-01'

),

PURCHASED_PREMIUM_CUSTOMERS AS (
  SELECT DISTINCT CUSTOMER_ID,
  O.REGISTRATION_DATE

  FROM "EDLDB"."ECOM_SANDBOX"."PREMIUM_PRODUCT_LIST" AS P
  LEFT JOIN ORDERS AS O ON P.PRODUCT_ID = O.PRODUCT_ID
)

SELECT
  TO_CHAR(PPC.CUSTOMER_ID) AS CUSTOMER_ID,
  PPC.REGISTRATION_DATE,
  CAST(OL.ORDER_PLACED_DTTM AS DATE) AS ORDER_PLACED_DATE,
  TO_CHAR(OL.ORDER_ID) AS ORDER_ID,
  TO_CHAR(OL.PRODUCT_ID) AS PRODUCT_ID,
  PD.CATEGORY_LEVEL1,
  PD.CATEGORY_LEVEL2,
  PD.CATEGORY_LEVEL3,
  PD.MERCH_CLASSIFICATION1,
  PD.MERCH_CLASSIFICATION2,
  CASE when OL.PART_NUMBER in (select DISTINCT PART_NUMBER from ECOM_SANDBOX.PREMIUM_PRODUCT_LIST) THEN 1 ELSE 0 END as IS_PREMIUM,
  COUNT(CASE when PD.MERCH_CLASSIFICATION1 in ('Consumables','Premium') then ORDER_ID ELSE NULL END) as CONSUMABLES_PREMIUM_ORDERS,
  OL.ORDER_LINE_TOTAL_PRICE AS ORDER_PRICE

FROM PURCHASED_PREMIUM_CUSTOMERS AS PPC
LEFT JOIN ECOM.ORDER_LINE OL
  ON PPC.CUSTOMER_ID = OL.CUSTOMER_ID

LEFT JOIN PDM.PRODUCT PD
  ON OL.PRODUCT_ID = PD.PRODUCT_ID