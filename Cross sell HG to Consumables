Cross sell HG to Consumables
WITH CUSTOMERS AS (
  SELECT DISTINCT
  CUSTOMER_ID,
  CASE WHEN ORDERS_L3M > 0 THEN 1 ELSE 0 END AS ACTIVE_3M, 
  ORDERS_L3M,
  ORDERS_L6M,
  ORDERS_L9M,
  ORDERS_L12M,
  FIRST_ORDER_DATE,
  LAST_ORDER_DATE,
  AUTOSHIP_STATUS,
  REGISTRATION_DATE
  FROM CDM.CUSTOMER_AGGREGATE
  
  WHERE REGISTRATION_DATE BETWEEN '2021-01-01' AND '2021-12-31'
  
),

ORDERS AS (
  
  SELECT
  CA.CUSTOMER_ID,
  CA.REGISTRATION_DATE,
  CA.FIRST_ORDER_DATE,
  OL.ORDER_ID,
  OL.PRODUCT_ID,
  PD.CATEGORY_LEVEL1,
  PD.CATEGORY_LEVEL2,
  PD.CATEGORY_LEVEL3,
  PD.MERCH_CLASSIFICATION1,
  PD.MERCH_CLASSIFICATION2,
  CAST(OL.ORDER_PLACED_DTTM AS DATE) AS ORDER_PLACED_DATE,
  OL.ORDER_LINE_TOTAL_PRICE AS ORDER_PRICE,
  CASE WHEN OL.ORDER_AUTO_REORDER_FLAG = 'TRUE' then 'Autoship' else 'Non_Autoship' end as ORDER_TYPE,
  ROW_NUMBER() OVER (PARTITION BY CA.CUSTOMER_ID, 
                     CASE WHEN OL.ORDER_AUTO_REORDER_FLAG = 'TRUE' then 'Autoship' else 'Non_Autoship' END ORDER BY OL.ORDER_PLACED_DTTM ASC) AS AS_RANKING,
  DENSE_RANK() OVER (PARTITION BY CA.CUSTOMER_ID ORDER BY OL.ORDER_PLACED_DTTM ASC) AS ORDER_RANKING
  
  FROM CUSTOMERS CA
  
  LEFT JOIN ECOM.ORDER_LINE OL
  ON CA.CUSTOMER_ID = OL.CUSTOMER_ID 
  AND OL.ORDER_LINE_TOTAL_PRICE != 0
  AND OL.ORDER_LINE_SHIPPED_DTTM IS NOT NULL
  AND OL.ORDER_STATUS NOT IN ('X', 'P', 'J')
  AND OL.ORDER_PLACED_DTTM BETWEEN '2021-01-01' AND '2021-12-31'
  
  LEFT JOIN PDM.PRODUCT PD
  ON OL.PRODUCT_ID = PD.PRODUCT_ID

),

MC1_DATES AS (
  SELECT
  CUSTOMER_ID,
  
  MIN(CASE WHEN MERCH_CLASSIFICATION1 = 'Consumables' THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_CONSUMABLES_DATE,
  MIN(CASE WHEN MERCH_CLASSIFICATION1 = 'Healthcare' THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_HEALTHCARE_DATE,
  MIN(CASE WHEN MERCH_CLASSIFICATION1 = 'Hard Goods' THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_HARDGOODS_DATE,
  MIN(CASE WHEN MERCH_CLASSIFICATION1 = 'Specialty' THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_SPECIALITY_DATE,
  MIN(CASE WHEN MERCH_CLASSIFICATION1 = 'Virtual Bundle' THEN ORDER_PLACED_DATE ELSE NULL END) AS FIRST_VB_DATE
  
  FROM ORDERS
  
  GROUP BY 1
),

GA_HITS AS (
  SELECT
    O.CUSTOMER_ID,

    SUM(CASE WHEN lower(EVENT_ACTION) = 'detail' AND lower(EVENT_CATEGORY) = 'eec' AND GA_SESSIONS_DATE > FIRST_ORDER_DATE AND GA_SESSIONS_DATE < M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PDP_HITS_BETWEEN_SESSIONS,
    //SUM(CASE WHEN lower(EVENT_ACTION) = 'impression' AND lower(EVENT_LABEL) in ('search-results','browse','brand-page','deals') AND GA_SESSIONS_DATE > FIRST_ORDER_DATE AND GA_SESSIONS_DATE < M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PLP_HITS_BETWEEN_SESSIONS,
    SUM(CASE WHEN lower(EVENT_ACTION) = 'impression' AND PAGE_PATH LIKE '%/b/%' AND GA_SESSIONS_DATE > FIRST_ORDER_DATE AND GA_SESSIONS_DATE < M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PLP_HITS_BETWEEN_SESSIONS,
    SUM(CASE WHEN lower(EVENT_ACTION) like '%add%to%cart%' AND lower(EVENT_CATEGORY) = 'eec' AND GA_SESSIONS_DATE > FIRST_ORDER_DATE AND GA_SESSIONS_DATE < M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS ATC_HITS_BETWEEN_SESSIONS,

    SUM(CASE WHEN lower(EVENT_ACTION) = 'detail' AND lower(EVENT_CATEGORY) = 'eec' AND GA_SESSIONS_DATE = M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PDP_HITS_ORDER_SESSION,
    //SUM(CASE WHEN lower(EVENT_ACTION) = 'impression' AND lower(EVENT_LABEL) in ('search-results','browse','brand-page','deals') AND GA_SESSIONS_DATE = M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PLP_HITS_ORDER_SESSION,
    SUM(CASE WHEN lower(EVENT_ACTION) = 'impression' AND PAGE_PATH LIKE '%/b/%' AND GA_SESSIONS_DATE = M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS PLP_HITS_ORDER_SESSION,
    SUM(CASE WHEN lower(EVENT_ACTION) like '%add%to%cart%' AND lower(EVENT_CATEGORY) = 'eec' AND GA_SESSIONS_DATE = M.FIRST_CONSUMABLES_DATE THEN 1 ELSE 0 END) AS ATC_HITS_ORDER_SESSION
  
  FROM
    ORDERS AS O
    JOIN MC1_DATES AS M ON O.CUSTOMER_ID = M.CUSTOMER_ID
    JOIN "EDLDB"."GA"."GA_SESSIONS_HITS_PRODUCTS_UNION" AS G ON O.CUSTOMER_ID = G.CUSTOMER_ID

  WHERE GA_SESSIONS_DATE BETWEEN '2021-01-01' AND '2021-12-31'
      AND G.CUSTOMER_ID IS NOT NULL
      AND FIRST_CONSUMABLES_DATE IS NOT NULL
      AND G.PRODUCT_MERCH_CLASSIFICATION1 = 'Consumables'

  GROUP BY 1
)

SELECT
    C.CUSTOMER_ID,
    C.FIRST_ORDER_DATE,
    M.FIRST_CONSUMABLES_DATE,
    PDP_HITS_BETWEEN_SESSIONS,
    PLP_HITS_BETWEEN_SESSIONS,
    ATC_HITS_BETWEEN_SESSIONS,
    PDP_HITS_ORDER_SESSION,
    PLP_HITS_ORDER_SESSION,
    ATC_HITS_ORDER_SESSION,
    CHANNEL_GROUPING,
    PRODUCT_MERCH_CLASSIFICATION1,
    PRODUCT_MERCH_CLASSIFICATION2
FROM
    "EDLDB"."ECOM_SANDBOX"."FO_HG_CUSTOMERS" as C
    JOIN GA_HITS AS GA ON C.CUSTOMER_ID = GA.CUSTOMER_ID
    JOIN MC1_DATES AS M ON C.CUSTOMER_ID = M.CUSTOMER_ID
    JOIN "EDLDB"."GA"."GA_SESSIONS_HITS_PRODUCTS_UNION" AS G ON C.CUSTOMER_ID = G.CUSTOMER_ID

WHERE
    GA_SESSIONS_DATE BETWEEN '2021-01-01' AND '2021-12-31'
    AND G.CUSTOMER_ID IS NOT NULL
    AND PRODUCT_MERCH_CLASSIFICATION1 = 'Consumables'
;